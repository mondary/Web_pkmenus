<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Menu TV</title>
  <link rel="icon" href="icon.png" type="image/png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Work+Sans:wght@300;400;600;700&display=swap");
    :root{
      --bg:#111111;
      --chalk:#1c1c1c;
      --chalk-2:#252525;
      --yellow:#f6c53f;
      --yellow-2:#f0b927;
      --text:#f5f2ea;
      --muted:#b8b2a6;
      --ink:#1b1a16;
      --border:rgba(255,255,255,.06);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Work Sans", system-ui, sans-serif;
      color:var(--text);
      background: var(--bg);
    }
    .board{
      height:100%;
      display:grid;
      grid-template-columns:0.28fr 0.72fr;
      gap:16px;
      padding:16px;
    }
    .side{
      background: linear-gradient(180deg, var(--yellow) 0%, var(--yellow-2) 100%);
      color:var(--ink);
      border-radius:var(--radius);
      padding:16px;
      display:grid;
      grid-template-rows:auto 1fr auto;
      gap:12px;
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
    }
    .side-top{
      display:none;
    }
    .brand{
      font-family: "Bebas Neue", sans-serif;
      font-size:34px;
      letter-spacing:1px;
    }
    .side-sub{display:none}
    .side-photo{
      background: transparent;
      border-radius:0;
      padding:0;
      border:0;
      display:grid;
      grid-template-rows:1fr;
      gap:0;
      min-height:0;
    }
    .frame{
      position:relative;
      min-height:0;
      height:100%;
      border-radius:12px;
      overflow:hidden;
      background:rgba(0,0,0,0.1);
      box-shadow: none;
    }
    .frame img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      opacity:0;
      transition:opacity 600ms ease;
    }
    .frame img.is-active{opacity:1}
    .caption{
      display: none;
    }
    .photo-meta{
      display: none;
    }
    #slInfo { display: none; }
    #suggestionTile {
      grid-column: span 2;
      border: 2px dashed rgba(255,255,255,0.25);
    }
    .side-bottom{
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 16px;
    }
    .today{
      font-family: "Bebas Neue", sans-serif;
      font-size:26px;
      letter-spacing:.5px;
      flex-shrink: 1;
      line-height: 1.1;
      min-width: 0; /* allows breaking words if necessary */
    }
    .clock{
      font-family: "Bebas Neue", sans-serif;
      font-size: 72px;
      line-height: 0.8;
      font-variant-numeric:tabular-nums;
      font-weight:400;
      color:#241c07;
      flex-shrink: 0;
      text-align: right;
    }
    .stage{
      background: var(--chalk);
      border-radius:var(--radius);
      border:0;
      padding:18px;
      display:grid;
      grid-template-rows:auto 1fr;
      gap:14px;
      position:relative;
      overflow:hidden;
    }
    .stage::after{content:"";position:absolute;inset:0;pointer-events:none}
    .stage-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:16px;
      position:relative;
      z-index:1;
    }
    .stage-title{
      font-family:"Bebas Neue", sans-serif;
      font-size:42px;
      letter-spacing:1px;
    }
    .stage-sub{display:none}
    .grid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0, 1fr));
      gap:14px;
      grid-auto-rows:1fr;
      min-height:0;
      position:relative;
      z-index:1;
    }
    .tile{
      border:0;
      border-radius:12px;
      padding:16px;
      background: rgba(255,255,255,.02);
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      gap:4px;
      position: relative;
      overflow: hidden;
      isolation: isolate;
      min-height: 180px;
    }
    .tile.is-today {
      transform: scale(1.02);
      z-index: 2;
    }
    .tile.is-today::after {
      content: "";
      position: absolute;
      inset: 0;
      box-shadow: inset 0 0 0 3px var(--yellow), inset 0 0 30px rgba(246, 197, 63, 0.4);
      background: rgba(255,255,255,0.05);
      pointer-events: none;
      z-index: 3;
      border-radius: 12px;
    }
    .tile.is-dragging {
      opacity: 0.4;
      transform: scale(0.95);
    }
    .tile.is-drag-over {
      background: rgba(255, 255, 255, 0.15);
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.4);
    }
    .tile.is-droppable {
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.1);
      border: 1px dashed rgba(255, 255, 255, 0.2);
    }
    .tile-bg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      z-index: -1;
      transition: opacity 1s ease;
      filter: brightness(0.4);
    }
    .tile-bg.loaded {
      opacity: 1;
    }
    .tile-day{
      position: absolute;
      top: 12px;
      left: 16px;
      font-family:"Bebas Neue", sans-serif;
      font-size:20px;
      letter-spacing:.6px;
      color:#f2d35b;
      text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    }
    .photo-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.15);
      border: 0;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      font-size: 13px;
      opacity: 0.6;
      transition: opacity 0.2s, background 0.2s, transform 0.2s;
    }
    .photo-btn:hover {
      opacity: 1;
      background: rgba(255,255,255,0.25);
      transform: scale(1.1);
    }
    .tile-title{
      font-family:"Bebas Neue", sans-serif;
      font-size:38px;
      font-weight:400;
      color:var(--text);
      line-height:0.95;
      text-shadow: 0 2px 8px rgba(0,0,0,0.8);
      margin-top:auto;
    }
    .tile-details{
      font-size:13px;
      color:#dadada;
      line-height:1.2;
      text-shadow: 0 1px 3px rgba(0,0,0,0.9);
      font-weight: 500;
    }
    .editor{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.95);
      display:none;
      align-items:flex-start;
      justify-content:flex-start;
      z-index:50;
    }
    .editor.is-open{display:flex}
    .editor-input{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      width:100%;
      border:0;
      border-radius:0;
      padding:28px 32px;
      font-family:"Bebas Neue", sans-serif;
      font-size:72px;
      letter-spacing:1.2px;
      background:transparent;
      color:var(--text);
      outline:none;
      text-align:left;
      vertical-align:top;
      resize:none;
      overflow:hidden;
    }
    @media (max-width: 980px){
      .board{
        grid-template-columns:1fr;
        grid-template-rows:auto 1fr;
        gap:12px;
      }
      .side{
        display:flex;
        flex-direction:column;
        gap:10px;
      }
      .side-photo{flex:1}
      .side-bottom{
        order:-1;
        align-items:center;
      }
      .clock{font-size:54px}
      .today{font-size:22px}
      .tile-title{font-size:30px}
    }
    @media (max-width: 700px), (max-height: 720px){
      .board{gap:10px}
      .clock{font-size:48px}
      .today{font-size:20px}
      .tile-title{font-size:24px}
      .tile-day{font-size:16px}
      .tile{min-height:140px}
      .editor-input{
        position:relative;
        height:auto;
        min-height:40vh;
        font-size:46px;
        padding:20px 20px;
      }
    }
    @media (max-width: 980px) and (min-width: 851px) and (max-height: 600px){
      .stage{padding:10px;gap:8px}
      .stage-title{font-size:28px}
      .stage-head{
        align-items:center;
        justify-content:space-between;
      }
      .side{
        display:grid;
        grid-template-rows:auto 1fr;
        gap:10px;
      }
      .side-bottom{
        order:0;
        align-items:center;
        justify-content:flex-end;
      }
      .side-photo{display:none}
      .grid{gap:8px}
      .tile{min-height:110px;padding:10px}
      .tile-title{font-size:26px}
      .tile-day{font-size:14px}
      .clock{font-size:48px}
      .today{font-size:16px}
    }
  </style>
</head>
<body>
  <div class="board">
    <aside class="side">
      <div class="side-top">
        <div class="side-sub">Planning repas a la TV</div>
      </div>

      <div class="side-photo">
        <div class="frame" id="frame">
          <div class="caption" id="capText">-</div>
        </div>
        <div class="photo-meta">
          <span id="photoCounter">0 / 0</span>
          <span id="slInfo">Diaporama</span>
        </div>
      </div>

      <div class="side-bottom">
        <div class="today" id="todayLabel">Semaine</div>
        <div class="clock" id="clock">--:--</div>
      </div>
    </aside>

    <section class="stage">
      <div class="stage-head">
        <div>
          <div class="stage-title">Menu de la semaine</div>
          <div class="stage-sub">Diners fixes + encart photos</div>
        </div>
      </div>

      <div class="grid" id="menuGrid"></div>
    </section>
  </div>
  <div class="editor" id="editor">
    <textarea class="editor-input" id="editorInput" rows="2"></textarea>
  </div>

  <script>
    /********************
     * CONFIG A MODIFIER
     ********************/
    const REMOTE_MENU_URL = "backend/menu.json";
    const REMOTE_MENU_ENABLED = Boolean(REMOTE_MENU_URL);
    const REMOTE_MENU_BUST_CACHE = true;

    const DEFAULT_MENU = [
      { day: "Lundi",    title: "Tagliatelles aux boulettes", details: "Sauce tomate, creme, gruyere" },
      { day: "Mardi",    title: "Fajitas", details: "Poulet, poivrons, oignon, tortillas" },
      { day: "Mercredi", title: "Gnocchis", details: "Jambon ou lardons, sauce tomate ou creme" },
      { day: "Jeudi",    title: "Poisson pane", details: "Riz, carottes rapees" },
      { day: "Vendredi", title: "Pizza", details: "Sauce tomate, mozzarella, salade verte" },
      { day: "Samedi",   title: "Burgers maison", details: "Pains, viande, fromage, frites" },
      { day: "Dimanche", title: "Cuisses de poulet roties", details: "Pommes de terre, haricots verts" }
    ];
    let MENU = DEFAULT_MENU.map(item => ({ ...item }));

    function saveMenuState() {
      if (REMOTE_MENU_ENABLED) {
        saveMenuRemote();
        return;
      }
      localStorage.setItem('menu_dashboard_state', JSON.stringify(MENU));
    }

    async function saveMenuRemote() {
      if (!REMOTE_MENU_ENABLED || typeof fetch !== "function") return;
      try {
        const payload = MENU.map(item => ({
          day: item.day,
          title: item.title,
          image: item.image || ""
        }));
        await fetch("backend/save-menu.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
      } catch (e) {
        console.warn("Remote menu save failed", e);
      }
    }

    function normalizeMenu(data) {
      if (!Array.isArray(data) || data.length === 0) return null;
      const cleaned = [];
      for (const item of data) {
        if (!item || typeof item !== "object") return null;
        const day = typeof item.day === "string" ? item.day.trim() : "";
        const title = typeof item.title === "string" ? item.title.trim() : "";
        if (!day || !title) return null;
        const image = typeof item.image === "string" ? item.image.trim() : "";
        cleaned.push({ day, title, details: "", image });
      }
      return cleaned;
    }

    function loadLocalMenuState() {
      const savedMenu = localStorage.getItem('menu_dashboard_state');
      if (savedMenu) {
        try {
          const parsed = JSON.parse(savedMenu);
          const normalized = normalizeMenu(parsed);
          if (normalized) MENU = normalized;
        } catch(e) { console.error("Failed to load saved menu", e); }
      }
    }

    async function loadMenu() {
      if (!REMOTE_MENU_ENABLED || typeof fetch !== "function") {
        loadLocalMenuState();
        return;
      }
      try {
        let url = REMOTE_MENU_URL;
        if (REMOTE_MENU_BUST_CACHE) {
          url += (url.includes("?") ? "&" : "?") + "ts=" + Date.now();
        }
        const response = await fetch(url, { cache: "no-store" });
        if (!response.ok) throw new Error("Remote menu request failed");
        const data = await response.json();
        const normalized = normalizeMenu(data);
        if (!normalized) throw new Error("Invalid remote menu format");
        MENU = normalized;
      } catch (e) {
        console.warn("Falling back to local menu", e);
        MENU = DEFAULT_MENU.map(item => ({ ...item }));
      }
    }

    const SUGGESTIONS = [
      "Lasagnes bolognaise", "Hachis parmentier", "Quiche lorraine",
      "Boeuf bourguignon", "Curry de poulet", "Paella", "Chili con carne",
      "Roti de porc", "Gratin dauphinois", "Tomates farcies", "Couscous",
      "Blanquette de veau", "Croque-monsieur", "Pates carbonara"
    ];

    const PHOTOS = [
      { src: "pwa/photos/20251212_071241.jpg", caption: "Photo 1" },
      { src: "pwa/photos/IMG-20251202-WA0020.jpg", caption: "Photo 2" },
      { src: "pwa/photos/IMG-20251225-WA0053.jpg", caption: "Photo 3" }
    ];

    const SLIDE_SECONDS = 8;
    const AUTO_REFRESH_SECONDS = 0;

    /********************
     * MENU
     ********************/
    const menuGrid = document.getElementById("menuGrid");
    const todayLabel = document.getElementById("todayLabel");
    const editor = document.getElementById("editor");
    const editorInput = document.getElementById("editorInput");
    let editorIndex = null;
    let editorInitial = "";

    let draggedIndex = null;

    function handleDragStart(e) {
      draggedIndex = e.currentTarget.dataset.index;
      e.dataTransfer.effectAllowed = 'move';
      e.currentTarget.classList.add('is-dragging');
      
      // Highlight potential drop targets
      document.querySelectorAll('.tile').forEach(t => {
        if (t !== e.currentTarget) t.classList.add('is-droppable');
      });
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      return false;
    }

    function handleDragEnter(e) {
      e.currentTarget.classList.add('is-drag-over');
    }

    function handleDragLeave(e) {
      e.currentTarget.classList.remove('is-drag-over');
    }

    function handleDrop(e) {
      e.stopPropagation();
      e.preventDefault();
      e.currentTarget.classList.remove('is-drag-over');
      const targetIndex = e.currentTarget.dataset.index;
      
      if (draggedIndex !== null && targetIndex !== undefined && draggedIndex !== targetIndex) {
        if (draggedIndex === "suggestion") {
          // Special case: Suggestion replaces day meal
          const suggTitleEl = document.getElementById("suggTitle");
          if (suggTitleEl) {
            MENU[targetIndex].title = suggTitleEl.textContent;
            MENU[targetIndex].details = ""; // Reset details for new suggestion
            MENU[targetIndex].image = "";
            
            // Clean up stored image preference for this day since it's a new dish
            const prefs = JSON.parse(localStorage.getItem('menu_image_prefs') || "{}");
            delete prefs[MENU[targetIndex].title]; // Optional: force fetch new
            
            renderMenu();
            updateSuggestion(); // Pick a new one for the suggestion tile
            saveMenuState();
          }
        } else {
          // Normal case: Swap title and details between the two objects in MENU array
          const tempTitle = MENU[draggedIndex].title;
          const tempDetails = MENU[draggedIndex].details;
          const tempImage = MENU[draggedIndex].image;
          
          MENU[draggedIndex].title = MENU[targetIndex].title;
          MENU[draggedIndex].details = MENU[targetIndex].details;
          MENU[draggedIndex].image = MENU[targetIndex].image;
          
          MENU[targetIndex].title = tempTitle;
          MENU[targetIndex].details = tempDetails;
          MENU[targetIndex].image = tempImage;
          
          renderMenu();
          saveMenuState();
        }
      }
      return false;
    }

    function handleDragEnd(e) {
      e.currentTarget.classList.remove('is-dragging');
      // Clean up all tiles
      document.querySelectorAll('.tile').forEach(t => {
        t.classList.remove('is-drag-over');
        t.classList.remove('is-droppable');
      });
    }

    function handleTileImageCycle(tile) {
      const images = JSON.parse(tile.dataset.images || "[]");
      if (images.length <= 1) return;

      let currentIndex = parseInt(tile.dataset.currentImageIndex || "0");
      currentIndex = (currentIndex + 1) % images.length;
      tile.dataset.currentImageIndex = currentIndex;

      const imgUrl = images[currentIndex];
      const imgEl = tile.querySelector(".tile-bg");
      if (imgEl) {
        imgEl.classList.remove("loaded");
        imgEl.src = imgUrl;
      }

      // Persist selection
      const titleEl = tile.querySelector('.tile-title');
      if (titleEl) {
        const dishTitle = titleEl.textContent;
        const prefs = JSON.parse(localStorage.getItem('menu_image_prefs') || "{}");
        prefs[dishTitle] = imgUrl;
        localStorage.setItem('menu_image_prefs', JSON.stringify(prefs));
      }

      const index = tile.dataset.index;
      if (index !== undefined && index !== "suggestion") {
        MENU[index].image = imgUrl;
        saveMenuState();
      }
    }

    function handleTileClick(e) {
      if (e.target.closest('.photo-btn')) return;
      if (e.currentTarget.classList.contains('is-dragging')) return;

      const tile = e.currentTarget;
      const index = tile.dataset.index;

      if (index === "suggestion") {
        updateSuggestion();
        return;
      }

      const currentTitle = MENU[index].title;
      openEditor(index, currentTitle);
    }

    function handlePhotoClick(e) {
      e.stopPropagation();
      const tile = e.currentTarget.closest('.tile');
      if (!tile) return;
      handleTileImageCycle(tile);
    }

    function openEditor(index, title) {
      editorIndex = index;
      editorInitial = title;
      editorInput.value = title;
      editor.classList.add("is-open");
      setTimeout(() => editorInput.focus(), 0);
    }

    function closeEditor() {
      editor.classList.remove("is-open");
      editorIndex = null;
      editorInitial = "";
    }

    function commitEditor() {
      if (editorIndex === null) return;
      const newTitle = editorInput.value.trim();
      if (!newTitle || newTitle === editorInitial) {
        closeEditor();
        return;
      }
      const oldTitle = MENU[editorIndex].title;
      MENU[editorIndex].title = newTitle;
      MENU[editorIndex].details = "";
      MENU[editorIndex].image = "";

      const prefs = JSON.parse(localStorage.getItem('menu_image_prefs') || "{}");
      delete prefs[oldTitle];
      localStorage.setItem('menu_image_prefs', JSON.stringify(prefs));

      renderMenu();
      saveMenuState();
      closeEditor();
    }

    async function fetchImage750g(query) {
      if (!query) return [];
      if (typeof fetch !== "function" || typeof DOMParser === "undefined") {
        return [];
      }
      try {
        const searchUrl = `https://www.750g.com/recherche/?q=${encodeURIComponent(query)}`;
        // Use CodeTabs proxy which is more reliable for scraping and returns raw content
        const response = await fetch(`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(searchUrl)}`);
        const htmlText = await response.text();
        if (!htmlText) return [];

        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlText, "text/html");
        
        // Find all images in search results
        const images = Array.from(doc.querySelectorAll('.card-media-wrapper img'))
                            .map(img => img.src)
                            .filter(src => src && src.includes('static.750g.com'));
        
        return [...new Set(images)]; // Return unique images
      } catch (e) {
        console.warn("Failed to fetch images for", query, e);
        return [];
      }
    }

    function renderMenu(){
      menuGrid.innerHTML = "";
      
      const todayIndex = new Date().getDay(); // 0=Sun, 1=Mon...
      // Map JS day index to our day names (assuming specific spelling)
      const dayNames = ["Dimanche", "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi"];
      const todayName = dayNames[todayIndex];

      MENU.forEach((item, index) => {
        const el = document.createElement("article");
        el.className = "tile";
        el.draggable = true;
        el.dataset.index = index;
        
        if (item.day === todayName) {
          el.classList.add("is-today");
        }
        
        el.addEventListener('dragstart', handleDragStart);
        el.addEventListener('dragover', handleDragOver);
        el.addEventListener('dragenter', handleDragEnter);
        el.addEventListener('dragleave', handleDragLeave);
        el.addEventListener('drop', handleDrop);
        el.addEventListener('dragend', handleDragEnd);
        el.addEventListener('click', handleTileClick);

        el.innerHTML = `
          <div class="tile-day">${escapeHtml(item.day)}</div>
          <div class="tile-title">${escapeHtml(item.title)}</div>
          <button class="photo-btn" title="Changer la photo"><i class="fas fa-image"></i></button>
        `;
        el.querySelector('.photo-btn').addEventListener('click', handlePhotoClick);
        menuGrid.appendChild(el);

        if (item.image) {
          el.dataset.images = JSON.stringify([item.image]);
          el.dataset.currentImageIndex = 0;

          const imgEl = document.createElement("img");
          imgEl.className = "tile-bg";
          imgEl.src = item.image;
          imgEl.onload = () => imgEl.classList.add("loaded");
          el.appendChild(imgEl);
        } else {
          // Fetch and append images
          fetchImage750g(item.title).then(urls => {
            if (urls && urls.length > 0) {
              el.dataset.images = JSON.stringify(urls);
              
              // Restore preference
              const prefs = JSON.parse(localStorage.getItem('menu_image_prefs') || "{}");
              const preferredUrl = prefs[item.title];
              let startIndex = 0;
              if (preferredUrl && urls.includes(preferredUrl)) {
                startIndex = urls.indexOf(preferredUrl);
              }
              
              el.dataset.currentImageIndex = startIndex;
              
              const imgEl = document.createElement("img");
              imgEl.className = "tile-bg";
              imgEl.src = urls[startIndex];
              imgEl.onload = () => imgEl.classList.add("loaded");
              el.appendChild(imgEl);
            }
          });
        }
      });

      // Suggestions Tile
      if (SUGGESTIONS.length > 0) {
        const suggEl = document.createElement("article");
        suggEl.className = "tile";
        suggEl.id = "suggestionTile";
        suggEl.draggable = true;
        suggEl.dataset.index = "suggestion";
        suggEl.addEventListener('click', handleTileClick);
        suggEl.addEventListener('dragstart', handleDragStart);
        suggEl.addEventListener('dragover', handleDragOver);
        suggEl.addEventListener('dragenter', handleDragEnter);
        suggEl.addEventListener('dragleave', handleDragLeave);
        suggEl.addEventListener('drop', handleDrop);
        suggEl.addEventListener('dragend', handleDragEnd);

        suggEl.innerHTML = `
          <div class="tile-day" style="color:var(--text)">Idee pour la suite</div>
          <div class="tile-title" id="suggTitle">...</div>
          <div class="tile-details">Suggestion de la semaine prochaine</div>
          <button class="photo-btn" title="Changer la photo"><i class="fas fa-image"></i></button>
        `;
        suggEl.querySelector('.photo-btn').addEventListener('click', handlePhotoClick);
        menuGrid.appendChild(suggEl);
        updateSuggestion();
        // Update every hour
        setInterval(updateSuggestion, 3600 * 1000); 
      }

      const now = new Date();
      todayLabel.textContent = now.toLocaleDateString("fr-FR", {
        weekday:"long", year:"numeric", month:"long", day:"numeric"
      });
    }

    async function updateSuggestion(forcedDish = null) {
      const tile = document.getElementById("suggestionTile");
      const titleEl = document.getElementById("suggTitle");
      if (!tile || !titleEl) return;

      const randomDish = forcedDish || SUGGESTIONS[Math.floor(Math.random() * SUGGESTIONS.length)];
      titleEl.textContent = randomDish;

      // Fetch new images
      const urls = await fetchImage750g(randomDish);
      
      // Clean up old image
      const oldImg = tile.querySelector(".tile-bg");
      if (oldImg) oldImg.remove();
      
      if (urls && urls.length > 0) {
        tile.dataset.images = JSON.stringify(urls);
        
        // Restore preference
        const prefs = JSON.parse(localStorage.getItem('menu_image_prefs') || "{}");
        const preferredUrl = prefs[randomDish];
        let startIndex = 0;
        if (preferredUrl && urls.includes(preferredUrl)) {
          startIndex = urls.indexOf(preferredUrl);
        }

        tile.dataset.currentImageIndex = startIndex;

        const imgEl = document.createElement("img");
        imgEl.className = "tile-bg";
        imgEl.src = urls[startIndex];
        imgEl.onload = () => imgEl.classList.add("loaded");
        tile.appendChild(imgEl);
      } else {
        tile.dataset.images = "[]";
        tile.dataset.currentImageIndex = 0;
      }
    }

    function escapeHtml(str){
      return String(str)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    /********************
     * SLIDESHOW
     ********************/
    const frame = document.getElementById("frame");
    const capText = document.getElementById("capText");
    const photoCounter = document.getElementById("photoCounter");
    const slInfo = document.getElementById("slInfo");

    let current = 0;
    let timer = null;

    function setupSlideshow(){
      PHOTOS.forEach((p, idx) => {
        const img = document.createElement("img");
        img.src = p.src;
        img.alt = p.caption || `Photo ${idx+1}`;
        img.dataset.index = idx;
        frame.insertBefore(img, frame.firstChild);
      });

      slInfo.textContent = PHOTOS.length ? "Diaporama actif" : "Aucune photo";
      photoCounter.textContent = PHOTOS.length ? `1 / ${PHOTOS.length}` : "0 / 0";

      goTo(0);
      start();
    }

    function goTo(idx){
      if(!PHOTOS.length) return;
      const imgs = frame.querySelectorAll("img");
      imgs.forEach(i => i.classList.remove("is-active"));
      const target = frame.querySelector(`img[data-index="${idx}"]`);
      if(target) target.classList.add("is-active");
      current = idx;
      capText.textContent = PHOTOS[idx].caption || `Photo ${idx+1}`;
      photoCounter.textContent = `${idx+1} / ${PHOTOS.length}`;
    }

    function next(){
      const n = (current + 1) % PHOTOS.length;
      goTo(n);
    }

    function start(){
      stop();
      if(!PHOTOS.length) return;
      timer = setInterval(next, SLIDE_SECONDS * 1000);
    }

    function stop(){
      if(timer) clearInterval(timer);
      timer = null;
    }

    /********************
     * UTIL
     ********************/
    const clock = document.getElementById("clock");
    setInterval(() => {
      const now = new Date();
      clock.textContent = now.toLocaleTimeString("fr-FR", { hour:"2-digit", minute:"2-digit" });
    }, 1000);

    if (AUTO_REFRESH_SECONDS > 0) {
      setTimeout(() => location.reload(), AUTO_REFRESH_SECONDS * 1000);
    }

    async function init() {
      await loadMenu();
      renderMenu();
      setupSlideshow();
    }

    init();

    editor.addEventListener("click", (e) => {
      if (e.target === editor) closeEditor();
    });
    editorInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") commitEditor();
      if (e.key === "Escape") closeEditor();
    });
  </script>
</body>
</html>
